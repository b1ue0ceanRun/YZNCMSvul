<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>图片剪裁</title>
    <link rel="stylesheet" href="__STATIC__/libs/layui/css/layui.css">
    <link rel="stylesheet" href="__STATIC__/libs/cropper/cropper.min.css">
    <link rel="stylesheet" href="__STATIC__/libs/cropper/main.css">
    <link rel="stylesheet" href="__STATIC__/common/font/iconfont.css">
    <style type="text/css">
    .layui-btn-group+.layui-btn-group {margin-left: 0px;}
    </style>
</head>

<body style="padding: 10px;">
    <div class="layui-container layui-form">
        <div class="layui-row layui-col-space10">
            <div class="layui-col-md8 layui-col-sm8">
                <div class="img-container">
                    <img id="image" src="{$Think.get.url}" alt="Picture">
                </div>
            </div>
            <div class="layui-col-md4 layui-col-sm4">
                <div class="docs-preview clearfix">
                    <div class="img-preview preview-lg"></div>
                    <div class="img-preview preview-md"></div>
                    <div class="img-preview preview-sm"></div>
                    <div class="img-preview preview-xs"></div>
                </div>
                <div class="docs-data layui-form layui-form-pane">
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 60px;">宽度</label>
                        <div class="layui-input-inline" style="width: 70px;">
                            <input type="text" id="dataWidth" class="layui-input">
                        </div>
                        <div class="layui-form-mid layui-word-aux">PX</div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 60px;">高度</label>
                        <div class="layui-input-inline" style="width: 70px;">
                            <input type="text" id="dataHeight" class="layui-input">
                        </div>
                        <div class="layui-form-mid layui-word-aux">PX</div>
                    </div>
                </div>
                <div class="docs-toggles">
                    <div class="layui-btn-group">
                        <button type="button" class="layui-btn layui-btn-sm" data-name="aspectRatio" value="1.7777777777777777">16:9</button>
                        <button type="button" class="layui-btn layui-btn-sm" data-name="aspectRatio" value="1.3333333333333333">4:3</button>
                        <button type="button" class="layui-btn layui-btn-sm" data-name="aspectRatio" value="1">1:1</button>
                        <button type="button" class="layui-btn layui-btn-sm" data-name="aspectRatio" value="0.6666666666666666">2:3</button>
                        <button type="button" class="layui-btn layui-btn-sm" data-name="aspectRatio" value="NaN">自由</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-row layui-col-space10" style="text-align: center;">
            <div class="layui-btn-group">
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-yidong"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-tailor"></i></button>
            </div>
            <div class="layui-btn-group">
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-fullscreen"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-narrow"></i></button>
            </div>
            <div class="layui-btn-group">
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-leftarrow"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-Rightarrow"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-rising"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-falling"></i></button>
            </div>
            <div class="layui-btn-group">
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-undo-alt"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-redo-alt"></i></button>
            </div>
            <div class="layui-btn-group">
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-arrows-alt-h"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-fa-arrows-alt-v"></i></button>
            </div>
            <div class="layui-btn-group">
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-lock"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-unlock"></i></button>
            </div>
            <div class="layui-btn-group">
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-shuaxin1"></i></button>
                <button type="button" class="layui-btn layui-btn-sm"><i class="iconfont icon-cloud-upload"></i></button>
            </div>
        </div>
    </div>
    <script src="__STATIC__/libs/jquery/jquery.min.js"></script>
    <script src="__STATIC__/libs/cropper/cropper.min.js"></script>
    <script type="text/javascript">
    $(function() {
        'use strict';
        var console = window.console || { log: function() {} };
        var URL = window.URL || window.webkitURL;
        var $image = $('#image');
        var $download = $('#download');
        /*var $dataX = $('#dataX');
        var $dataY = $('#dataY');*/
        var $dataHeight = $('#dataHeight');
        var $dataWidth = $('#dataWidth');
        /*var $dataRotate = $('#dataRotate');
        var $dataScaleX = $('#dataScaleX');
        var $dataScaleY = $('#dataScaleY');*/
        var options = {
            aspectRatio: 16 / 9,
            preview: '.img-preview',
            crop: function(e) {
                /*$dataX.val(Math.round(e.detail.x));
                $dataY.val(Math.round(e.detail.y));*/
                $dataHeight.val(Math.round(e.detail.height));
                $dataWidth.val(Math.round(e.detail.width));
                /*$dataRotate.val(e.detail.rotate);
                $dataScaleX.val(e.detail.scaleX);
                $dataScaleY.val(e.detail.scaleY);*/
            }
        };
        var originalImageURL = $image.attr('src');
        var uploadedImageName = 'cropped.jpg';
        var uploadedImageType = 'image/jpeg';
        var uploadedImageURL;

        // Cropper
        $image.on({
            ready: function(e) {
                //console.log(e);
            },
            cropstart: function(e) {
                //console.log(e);
            },
            cropmove: function(e) {
                //console.log(e);
            },
            cropend: function(e) {
                //console.log(e);
            },
            crop: function(e) {
                //console.log(e);
            },
            zoom: function(e) {
                //console.log(e);
            }
        }).cropper(options);

        // Buttons
        if (!$.isFunction(document.createElement('canvas').getContext)) {
            $('button[data-method="getCroppedCanvas"]').prop('disabled', true);
        }

        if (typeof document.createElement('cropper').style.transition === 'undefined') {
            $('button[data-method="rotate"]').prop('disabled', true);
            $('button[data-method="scale"]').prop('disabled', true);
        }

        // Download
        /*if (typeof $download[0].download === 'undefined') {
            $download.addClass('disabled');
        }*/

        // 选择比例
        $('.docs-toggles').on('click', 'button', function() {
            var $this = $(this);
            var name = $this.data('name');
            var type = $this.prop('type');
            var cropBoxData;
            var canvasData;


            if (!$image.data('cropper')) {
                return;
            }

            options[name] = $this.val();
            $image.cropper('destroy').cropper(options);
        });

        // Methods
        $('.docs-buttons').on('click', '[data-method]', function() {
            var $this = $(this);
            var data = $this.data();
            var cropper = $image.data('cropper');
            var cropped;
            var $target;
            var result;

            if ($this.prop('disabled') || $this.hasClass('disabled')) {
                return;
            }

            if (cropper && data.method) {
                data = $.extend({}, data); // Clone a new one

                if (typeof data.target !== 'undefined') {
                    $target = $(data.target);

                    if (typeof data.option === 'undefined') {
                        try {
                            data.option = JSON.parse($target.val());
                        } catch (e) {
                            console.log(e.message);
                        }
                    }
                }

                cropped = cropper.cropped;

                switch (data.method) {
                    case 'rotate':
                        if (cropped && options.viewMode > 0) {
                            $image.cropper('clear');
                        }

                        break;

                    case 'getCroppedCanvas':
                        if (uploadedImageType === 'image/jpeg') {
                            if (!data.option) {
                                data.option = {};
                            }

                            data.option.fillColor = '#fff';
                        }

                        break;
                }

                result = $image.cropper(data.method, data.option, data.secondOption);

                switch (data.method) {
                    case 'rotate':
                        if (cropped && options.viewMode > 0) {
                            $image.cropper('crop');
                        }

                        break;

                    case 'scaleX':
                    case 'scaleY':
                        $(this).data('option', -data.option);
                        break;

                    case 'getCroppedCanvas':
                        if (result) {
                            // Bootstrap's Modal
                            $('#getCroppedCanvasModal').modal().find('.modal-body').html(result);

                            if (!$download.hasClass('disabled')) {
                                download.download = uploadedImageName;
                                $download.attr('href', result.toDataURL(uploadedImageType));
                            }
                        }

                        break;

                    case 'destroy':
                        if (uploadedImageURL) {
                            URL.revokeObjectURL(uploadedImageURL);
                            uploadedImageURL = '';
                            $image.attr('src', originalImageURL);
                        }

                        break;
                }

                if ($.isPlainObject(result) && $target) {
                    try {
                        $target.val(JSON.stringify(result));
                    } catch (e) {
                        console.log(e.message);
                    }
                }
            }
        });

        // Keyboard
        $(document.body).on('keydown', function(e) {
            if (e.target !== this || !$image.data('cropper') || this.scrollTop > 300) {
                return;
            }

            switch (e.which) {
                case 37:
                    e.preventDefault();
                    $image.cropper('move', -1, 0);
                    break;

                case 38:
                    e.preventDefault();
                    $image.cropper('move', 0, -1);
                    break;

                case 39:
                    e.preventDefault();
                    $image.cropper('move', 1, 0);
                    break;

                case 40:
                    e.preventDefault();
                    $image.cropper('move', 0, 1);
                    break;
            }
        });

        // Import image
        var $inputImage = $('#inputImage');

        if (URL) {
            $inputImage.change(function() {
                var files = this.files;
                var file;

                if (!$image.data('cropper')) {
                    return;
                }

                if (files && files.length) {
                    file = files[0];

                    if (/^image\/\w+$/.test(file.type)) {
                        uploadedImageName = file.name;
                        uploadedImageType = file.type;

                        if (uploadedImageURL) {
                            URL.revokeObjectURL(uploadedImageURL);
                        }

                        uploadedImageURL = URL.createObjectURL(file);
                        $image.cropper('destroy').attr('src', uploadedImageURL).cropper(options);
                        $inputImage.val('');
                    } else {
                        window.alert('Please choose an image file.');
                    }
                }
            });
        } else {
            $inputImage.prop('disabled', true).parent().addClass('disabled');
        }

    });
    </script>
</body>

</html>